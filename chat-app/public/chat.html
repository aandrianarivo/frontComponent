<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat de groupe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html { height: 100%; margin: 0; }
    .chat-container { display: flex; flex-direction: column; height: 100vh; }
    .messages-list { flex: 1; overflow-y: auto; padding: 1rem; background: #f0f0f0; }
    .input-area { padding: 0.5rem; border-top: 1px solid #ddd; }
    .message { margin-bottom: 0.5rem; }
    .message .user { font-weight: bold; }
  </style>
</head>
<body>
  <script>
    const user = localStorage.getItem('chatUser');
    if (!user) window.location.href = '/login.html';
  </script>
  <div class="chat-container">
    <div id="messages" class="messages-list"></div>
    <div class="input-area d-flex">
      <input id="text" class="form-control me-2" placeholder="Ã‰crivez votre message...">
      <button id="sendBtn" class="btn btn-primary">Envoyer</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const messagesEl = document.getElementById('messages');
    const inputText = document.getElementById('text');
    const sendBtn = document.getElementById('sendBtn');
    let offset = 0, limit = 20, loading = false;

    function appendMsg(m) {
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `<span class="user">${m.user}</span>: <span class="text">${m.text}</span> <small class="time text-muted">${new Date(m.timestamp).toLocaleTimeString()}</small>`;
      messagesEl.append(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function loadBatch() {
      if (loading) return;
      loading = true;
      const res = await fetch(`/messages?offset=${offset}&limit=${limit}`);
      const { messages } = await res.json();
      messages.forEach(appendMsg);
      offset += messages.length;
      loading = false;
    }
    loadBatch();

    sendBtn.onclick = () => {
      const text = inputText.value.trim(); if (!text) return;
      socket.emit('newMessage', text);
      inputText.value = '';
    };
    inputText.addEventListener('keypress', e => { if (e.key==='Enter'){e.preventDefault(); sendBtn.click();} });
    socket.on('message', appendMsg);
  </script>
</body>
</html>